name: Release to Discord

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_name:
        description: 'ãƒªãƒªãƒ¼ã‚¹åï¼ˆä¾‹: v0.1.0 - Initial Releaseï¼‰'
        required: true
        type: string
      release_url:
        description: 'ãƒªãƒªãƒ¼ã‚¹URL'
        required: true
        type: string
      release_notes:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆAIè¦ç´„ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼‰'
        required: false
        type: string
      enable_summarization:
        description: 'AIè¦ç´„ã‚’æœ‰åŠ¹åŒ–'
        type: boolean
        default: false

jobs:
  post-to-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Post release to Discord
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_NAME="${{ inputs.release_name }}"
            RELEASE_URL="${{ inputs.release_url }}"
            RELEASE_NOTES="${{ inputs.release_notes }}"
          else
            RELEASE_NAME="${{ github.event.release.name }}"
            RELEASE_URL="${{ github.event.release.html_url }}"
            RELEASE_NOTES="${{ github.event.release.body }}"
          fi

          # Check if summarization is enabled
          if [ "${{ inputs.enable_summarization }}" = "true" ] && [ -n "$RELEASE_NOTES" ]; then
            SUMMARY=$(node scripts/ai-summarize.js "$RELEASE_NOTES" 2>/dev/null | grep -A 100 "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸè¦ç´„:" | tail -n +2 | head -n -1 | sed 's/^---//g' | tr -d '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            if [ -z "$SUMMARY" ]; then
              SUMMARY="æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼"
            fi
            node scripts/post-discord.js "$RELEASE_NAME" "$RELEASE_URL" "$SUMMARY"
          else
            node scripts/post-discord.js "$RELEASE_NAME" "$RELEASE_URL"
          fi
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-3.5-turbo' }}
