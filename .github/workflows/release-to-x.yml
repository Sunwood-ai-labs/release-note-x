name: Release to X

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_name:
        description: 'ãƒªãƒªãƒ¼ã‚¹åï¼ˆä¾‹: v0.1.0 - Initial Releaseï¼‰'
        required: true
        type: string
      release_url:
        description: 'ãƒªãƒªãƒ¼ã‚¹URL'
        required: true
        type: string
      release_notes:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆAIè¦ç´„ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼‰'
        required: false
        type: string
      enable_summarization:
        description: 'AIè¦ç´„ã‚’æœ‰åŠ¹åŒ–'
        type: boolean
        default: false

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Post release to X
        run: |
          RELEASE_NAME="${{ inputs.release_name || github.event.release.name }}"
          RELEASE_URL="${{ inputs.release_url || github.event.release.html_url }}"

          # Check if summarization is enabled (for both release and workflow_dispatch)
          # For release events: enabled by default if OPENAI_API_KEY is set
          # For workflow_dispatch: use the input parameter
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENABLE_SUMMARY="${{ inputs.enable_summarization == 'true' && 'true' || 'false' }}"
          else
            # For release events, enable summarization if OPENAI_API_KEY or OPENROUTER_API_KEY is set
            ENABLE_SUMMARY="${{ (secrets.OPENAI_API_KEY != '' || secrets.OPENROUTER_API_KEY != '') && 'true' || 'false' }}"
          fi
          if [ "$ENABLE_SUMMARY" = "true" ] && [ -n "$RELEASE_NOTES" ]; then
            echo "ğŸ“ AIè¦ç´„ã‚’ç”Ÿæˆã—ã¾ã™..."
            SUMMARY=$(RELEASE_NOTES="$RELEASE_NOTES" node scripts/ai-summarize.js --quiet --env)
            if [ -z "$SUMMARY" ]; then
              echo "âš ï¸ è¦ç´„ãŒç©ºã ã£ãŸãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™"
              SUMMARY="$RELEASE_NAME"
            else
              echo "âœ… AIè¦ç´„ã‚’ç”Ÿæˆã—ã¾ã—ãŸ"
            fi
            node scripts/post-x.js "$SUMMARY" "$RELEASE_URL"
          else
            node scripts/post-release.js "$RELEASE_NAME" "$RELEASE_URL"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_BASE_URL: ${{ secrets.OPENROUTER_BASE_URL }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL != '' && secrets.OPENROUTER_MODEL || 'z-ai/glm-4.5-air:free' }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL != '' && secrets.OPENAI_MODEL || 'gpt-3.5-turbo' }}
          RELEASE_NOTES: ${{ inputs.release_notes != '' && inputs.release_notes || github.event.release.body }}
